{% extends 'demo/base.html' %}

{% block title %}Analytics - Ladder AI Expense Tracker{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Average Daily</span>
                <div class="stat-icon">
                    <svg width="16" height="16">
                        <use href="#trending-up"></use>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="avgDaily">$0</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Top Category</span>
                <div class="stat-icon">
                    <svg width="16" height="16">
                        <use href="#bar-chart-3"></use>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="topCategory">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">AI Accuracy</span>
                <div class="stat-icon">
                    <svg width="16" height="16">
                        <use href="#brain"></use>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="aiAccuracy">85%</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Predictions</span>
                <div class="stat-icon">
                    <svg width="16" height="16">
                        <use href="#zap"></use>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="predictions">0</div>
        </div>
    </div>

    <div class="content-grid">
        <div class="main-content">
            <h2 class="section-title">Expense Trends</h2>
            <div style="height: 300px; display: flex; align-items: center; justify-content: center; color: #666;">
                <canvas id="expenseChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="sidebar">
            <h2 class="section-title">Category Breakdown</h2>
            <div id="categoryBreakdown">
                <!-- Category breakdown will be loaded here -->
            </div>
            
            <h2 class="section-title" style="margin-top: 24px;">Anomalies Detected</h2>
            <div id="anomaliesSection">
                <!-- Anomalies will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let expenses = [];
    
    async function loadAnalyticsData() {
        try {
            // Load expenses from API
            const expensesResponse = await fetch('/api/expenses/');
            if (expensesResponse.ok) {
                const expensesData = await expensesResponse.json();
                expenses = expensesData.results || expensesData;
            }
            
            // Load insights including anomalies
            const insightsResponse = await fetch('/api/ai/insights/');
            if (insightsResponse.ok) {
                const insights = await insightsResponse.json();
                renderAnomalies(insights.anomalies || []);
            }
        } catch (error) {
            console.error('Error loading analytics data:', error);
            expenses = [];
            renderAnomalies([]);
        }
        
        updateAnalytics();
        renderChart();
        renderCategoryBreakdown();
    }
    
    function updateAnalytics() {
        const total = expenses.reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
        const avgDaily = total / 30;
        
        // Find top category
        const categoryTotals = {};
        expenses.forEach(expense => {
            const amount = parseFloat(expense.amount) || 0;
            categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + amount;
        });
        
        const topCategory = Object.keys(categoryTotals).length > 0 
            ? Object.keys(categoryTotals).reduce((a, b) => 
                categoryTotals[a] > categoryTotals[b] ? a : b
            ) : 'none';
        
        document.getElementById('avgDaily').textContent = formatCurrency(avgDaily);
        document.getElementById('topCategory').textContent = topCategory.charAt(0).toUpperCase() + topCategory.slice(1);
        document.getElementById('predictions').textContent = expenses.filter(e => e.ai_predicted).length;
    }
    
    function renderChart() {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        
        if (expenses.length === 0) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('No expense data to display', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        
        // Group expenses by date
        const dailyTotals = {};
        expenses.forEach(expense => {
            const date = expense.date;
            const amount = parseFloat(expense.amount) || 0;
            dailyTotals[date] = (dailyTotals[date] || 0) + amount;
        });
        
        const dates = Object.keys(dailyTotals).sort();
        const amounts = dates.map(date => dailyTotals[date]);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates.map(date => new Date(date).toLocaleDateString()),
                datasets: [{
                    label: 'Daily Expenses',
                    data: amounts,
                    borderColor: '#1a1a1a',
                    backgroundColor: 'rgba(26, 26, 26, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }
    
    function renderCategoryBreakdown() {
        const categoryTotals = {};
        expenses.forEach(expense => {
            const amount = parseFloat(expense.amount) || 0;
            categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + amount;
        });
        
        const total = Object.values(categoryTotals).reduce((sum, amount) => sum + amount, 0);
        
        const breakdown = document.getElementById('categoryBreakdown');
        if (total === 0) {
            breakdown.innerHTML = '<p style="color: #666; font-size: 14px;">No expenses to analyze</p>';
            return;
        }
        
        breakdown.innerHTML = Object.entries(categoryTotals)
            .sort(([,a], [,b]) => b - a)
            .map(([category, amount]) => {
                const percentage = total > 0 ? ((amount / total) * 100).toFixed(1) : '0.0';
                return `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-weight: 500; text-transform: capitalize;">${category}</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                        <div style="background-color: #f5f5f5; border-radius: 4px; height: 8px;">
                            <div style="background-color: #1a1a1a; height: 100%; width: ${percentage}%; border-radius: 4px;"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">${percentage}%</div>
                    </div>
                `;
            }).join('');
    }
    
    function renderAnomalies(anomalies) {
        const anomaliesSection = document.getElementById('anomaliesSection');
        
        if (anomalies.length === 0) {
            anomaliesSection.innerHTML = '<p style="color: #666; font-size: 14px;">No unusual spending detected</p>';
            return;
        }
        
        anomaliesSection.innerHTML = anomalies.map(anomaly => `
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-weight: 500; font-size: 14px;">${anomaly.description}</span>
                    <span style="font-weight: 600; color: #d63031;">${formatCurrency(anomaly.amount)}</span>
                </div>
                <div style="font-size: 12px; color: #666;">
                    ${new Date(anomaly.date).toLocaleDateString()} â€¢ Unusually high expense
                </div>
            </div>
        `).join('');
    }
    
    document.addEventListener('DOMContentLoaded', loadAnalyticsData);
</script>
{% endblock %}