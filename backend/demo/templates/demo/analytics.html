{% extends 'demo/base.html' %}

{% block title %}Analytics - Ladder AI Expense Tracker{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Average Daily</span>
                <div class="stat-icon">
                    <svg width="16" height="16">
                        <use href="#trending-up"></use>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="avgDaily">$0</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Top Category</span>
                <div class="stat-icon">
                    <svg width="16" height="16">
                        <use href="#bar-chart-3"></use>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="topCategory">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">AI Accuracy</span>
                <div class="stat-icon">
                    <svg width="16" height="16">
                        <use href="#brain"></use>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="aiAccuracy">85%</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Predictions</span>
                <div class="stat-icon">
                    <svg width="16" height="16">
                        <use href="#zap"></use>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="predictions">0</div>
        </div>
    </div>

    <div class="content-grid">
        <div class="main-content">
            <h2 class="section-title">Expense Trends</h2>
            <div style="height: 300px; display: flex; align-items: center; justify-content: center; color: #666;">
                <canvas id="expenseChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="sidebar">
            <h2 class="section-title">Category Breakdown</h2>
            <div id="categoryBreakdown">
                <!-- Category breakdown will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let expenses = [];
    
    function loadAnalyticsData() {
        // Mock data - in real app, fetch from API
        expenses = [
            { amount: 45.50, category: 'food', date: '2024-01-15' },
            { amount: 12.00, category: 'transport', date: '2024-01-14' },
            { amount: 89.99, category: 'utilities', date: '2024-01-13' },
            { amount: 25.00, category: 'food', date: '2024-01-12' },
            { amount: 15.50, category: 'transport', date: '2024-01-11' }
        ];
        
        updateAnalytics();
        renderChart();
        renderCategoryBreakdown();
    }
    
    function updateAnalytics() {
        const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        const avgDaily = total / 30; // Assuming 30 days
        
        // Find top category
        const categoryTotals = {};
        expenses.forEach(expense => {
            categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
        });
        const topCategory = Object.keys(categoryTotals).reduce((a, b) => 
            categoryTotals[a] > categoryTotals[b] ? a : b, 'none'
        );
        
        document.getElementById('avgDaily').textContent = formatCurrency(avgDaily);
        document.getElementById('topCategory').textContent = topCategory.charAt(0).toUpperCase() + topCategory.slice(1);
        document.getElementById('predictions').textContent = expenses.length;
    }
    
    function renderChart() {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        
        // Group expenses by date
        const dailyTotals = {};
        expenses.forEach(expense => {
            const date = expense.date;
            dailyTotals[date] = (dailyTotals[date] || 0) + expense.amount;
        });
        
        const dates = Object.keys(dailyTotals).sort();
        const amounts = dates.map(date => dailyTotals[date]);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates.map(date => new Date(date).toLocaleDateString()),
                datasets: [{
                    label: 'Daily Expenses',
                    data: amounts,
                    borderColor: '#1a1a1a',
                    backgroundColor: 'rgba(26, 26, 26, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }
    
    function renderCategoryBreakdown() {
        const categoryTotals = {};
        expenses.forEach(expense => {
            categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
        });
        
        const total = Object.values(categoryTotals).reduce((sum, amount) => sum + amount, 0);
        
        const breakdown = document.getElementById('categoryBreakdown');
        breakdown.innerHTML = Object.entries(categoryTotals)
            .sort(([,a], [,b]) => b - a)
            .map(([category, amount]) => {
                const percentage = ((amount / total) * 100).toFixed(1);
                return `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-weight: 500; text-transform: capitalize;">${category}</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                        <div style="background-color: #f5f5f5; border-radius: 4px; height: 8px;">
                            <div style="background-color: #1a1a1a; height: 100%; width: ${percentage}%; border-radius: 4px;"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">${percentage}%</div>
                    </div>
                `;
            }).join('');
    }
    
    document.addEventListener('DOMContentLoaded', loadAnalyticsData);
</script>
{% endblock %}