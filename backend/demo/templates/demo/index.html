{% extends 'demo/base.html' %}

{% block title %}AI-Powered Expense Tracker{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Total Expenses</span>
                <div class="stat-icon">
                    <svg width="16" height="16"><use href="#credit-card"></use></svg>
                </div>
            </div>
            <div class="stat-value" id="totalExpenses">₵0</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">This Month</span>
                <div class="stat-icon">
                    <svg width="16" height="16"><use href="#calendar"></use></svg>
                </div>
            </div>
            <div class="stat-value" id="monthlyExpenses">₵0</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">AI Predictions</span>
                <div class="stat-icon">
                    <svg width="16" height="16"><use href="#brain"></use></svg>
                </div>
            </div>
            <div class="stat-value" id="aiPredictions">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">Categories</span>
                <div class="stat-icon">
                    <svg width="16" height="16"><use href="#tag"></use></svg>
                </div>
            </div>
            <div class="stat-value" id="categoryCount">0</div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
        <!-- Expense List -->
        <div class="main-content">
            <h2 class="section-title">Your Expenses</h2>
            <div class="expense-list" id="expenseList">
                <p style="text-align: center; color: #666; margin: 40px 0;">No expenses yet. Add your first expense to get started.</p>
            </div>
        </div>

        <!-- Add Expense Sidebar -->
        <div class="sidebar">
            <h2 class="section-title">Add New Expense</h2>
            
            <!-- AI Categorization Section -->
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <h6 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                    <svg width="16" height="16"><use href="#brain"></use></svg>
                    AI Assistant
                </h6>
                <div class="form-group">
                    <label class="form-label">AI Model</label>
                    <select class="form-select" id="aiModel" style="font-size: 12px;">
                        <option value="auto">Auto (Best Available)</option>
                        <option value="smol_vlm">SmolVLM Transformer</option>
                        <option value="ml_primary">ML Enhanced</option>
                        <option value="rule_based">Rule-Based</option>
                    </select>
                </div>
                <div id="aiResult" class="hidden" style="margin-top: 12px; padding: 12px; background: #e8f5e8; border-radius: 6px; border: 1px solid #c3e6c3;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <small><strong>AI Categorized:</strong> <span id="aiCategory" style="text-transform: capitalize; color: #059669; font-weight: bold;"></span></small>
                        <small style="color: #666;">(<span id="aiConfidence"></span>% confidence)</small>
                    </div>
                    <div style="background: #d4edda; border-radius: 4px; height: 4px; margin-bottom: 8px;">
                        <div id="aiConfidenceBar" style="background: #059669; height: 100%; border-radius: 4px; transition: width 0.3s;"></div>
                    </div>
                    <small style="color: #666; font-size: 11px;">Category automatically set. Change below if needed.</small>
                    <div id="modelInfo" style="margin-top: 6px; padding: 6px; background: #f0f0f0; border-radius: 4px; font-size: 10px; color: #555;">
                        <strong>Model:</strong> <span id="modelDetails"></span>
                    </div>
                </div>
            </div>

            <!-- Expense Form -->
            <form class="expense-form" id="expenseForm">
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <input type="number" class="form-input" id="amount" placeholder="0.00" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="description" placeholder="e.g., Waakye at chop bar" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Category <small style="color: #666;">(AI auto-filled, override if needed)</small></label>
                    <select class="form-select" id="category" required>
                        <option value="">Waiting for AI categorization...</option>
                        <option value="food">Food</option>
                        <option value="transport">Transport</option>
                        <option value="shopping">Shopping</option>
                        <option value="bills">Bills</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="education">Education</option>
                        <option value="travel">Travel</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="date" required>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16"><use href="#plus"></use></svg>
                    Add Expense
                </button>
            </form>

            <!-- Quick Examples -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e5e5;">
                <h6 style="margin: 0 0 12px 0; color: #666; font-size: 12px;">Quick Examples:</h6>
                <div style="display: grid; gap: 6px;">
                    <button type="button" class="btn example-btn" data-text="Waakye at Auntie Muni chop bar" style="background: #f8f9fa; color: #666; font-size: 11px; padding: 6px 10px; text-align: left;">Waakye at chop bar</button>
                    <button type="button" class="btn example-btn" data-text="Trotro fare to Kotoka Airport" style="background: #f8f9fa; color: #666; font-size: 11px; padding: 6px 10px; text-align: left;">Trotro to airport</button>
                    <button type="button" class="btn example-btn" data-text="ECG electricity bill payment" style="background: #f8f9fa; color: #666; font-size: 11px; padding: 6px 10px; text-align: left;">ECG bill payment</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let expenses = [];
let aiPredictionCount = 0;

const categoryIcons = {
    food: 'utensils',
    transport: 'car',
    entertainment: 'film',
    bills: 'zap',
    shopping: 'shopping-cart',
    healthcare: 'heart',
    education: 'user',
    travel: 'car',
    other: 'tag'
};

let debounceTimer;
let currentAIPrediction = null;

async function init() {
    document.getElementById('date').valueAsDate = new Date();
    await loadExpenses();
    updateStats();
    renderExpenses();
}

async function loadExpenses() {
    try {
        const response = await fetch('/api/expenses/');
        
        if (response.ok) {
            const data = await response.json();
            expenses = data.results || data; // Handle paginated or direct array response
            
            // Add UI-specific properties
            expenses = expenses.map(expense => ({
                ...expense,
                aiPredicted: expense.ai_predicted || false,
                manualOverride: expense.ai_predicted === false && expense.ai_confidence
            }));
            
            aiPredictionCount = expenses.filter(e => e.aiPredicted).length;
        } else {
            // Fallback to sample data if API fails or user not authenticated
            loadSampleData();
        }
    } catch (error) {
        console.error('Error loading expenses:', error);
        loadSampleData();
    }
}

function loadSampleData() {
    expenses = [
        {
            id: 1,
            amount: 15.50,
            description: 'Waakye at Auntie Muni chop bar',
            category: 'food',
            date: '2024-01-15',
            aiPredicted: true,
            aiConfidence: 0.92
        },
        {
            id: 2,
            amount: 8.00,
            description: 'Trotro fare to Kotoka Airport',
            category: 'transport',
            date: '2024-01-14',
            aiPredicted: true,
            aiConfidence: 0.88
        },
        {
            id: 3,
            amount: 125.00,
            description: 'ECG electricity bill payment',
            category: 'bills',
            date: '2024-01-13',
            aiPredicted: false
        }
    ];
    aiPredictionCount = expenses.filter(e => e.aiPredicted).length;
}

function updateStats() {
    const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
    const thisMonth = expenses
        .filter(expense => new Date(expense.date).getMonth() === new Date().getMonth())
        .reduce((sum, expense) => sum + expense.amount, 0);
    const categories = new Set(expenses.map(expense => expense.category)).size;
    
    document.getElementById('totalExpenses').textContent = formatCurrency(total);
    document.getElementById('monthlyExpenses').textContent = formatCurrency(thisMonth);
    document.getElementById('aiPredictions').textContent = aiPredictionCount;
    document.getElementById('categoryCount').textContent = categories;
}

function renderExpenses() {
    const expenseList = document.getElementById('expenseList');
    
    if (expenses.length === 0) {
        expenseList.innerHTML = '<p style="text-align: center; color: #666; margin: 40px 0;">No expenses yet. Add your first expense to get started.</p>';
        return;
    }

    expenseList.innerHTML = expenses
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .map(expense => `
            <div class="expense-item">
                <div class="expense-info">
                    <div class="expense-category">
                        <svg width="16" height="16">
                            <use href="#${categoryIcons[expense.category] || 'tag'}"></use>
                        </svg>
                    </div>
                    <div class="expense-details">
                        <div class="expense-title">
                            ${expense.description}
                            ${expense.aiPredicted ? '<span style="background: #059669; color: white; font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-left: 6px;">AI</span>' : ''}
                            ${expense.manualOverride ? '<span style="background: #f59e0b; color: white; font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-left: 6px;">Override</span>' : ''}
                        </div>
                        <div class="expense-date">${new Date(expense.date).toLocaleDateString()}</div>
                    </div>
                </div>
                <div class="expense-amount">${formatCurrency(expense.amount)}</div>
            </div>
        `).join('');
}

// AI Categorization
document.getElementById('description').addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        if (this.value.trim().length > 3) {
            categorizeExpense(this.value);
        } else {
            document.getElementById('aiResult').classList.add('hidden');
        }
    }, 800);
});

// Re-categorize when AI model changes
document.getElementById('aiModel').addEventListener('change', function() {
    const description = document.getElementById('description').value;
    if (description.trim().length > 3) {
        categorizeExpense(description);
    }
});

async function categorizeExpense(description) {
    try {
        const response = await fetch('/demo/categorize/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                description: description,
                model: document.getElementById('aiModel').value 
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('AI Response:', data); // Debug log
        
        // Validate response data
        if (!data.predicted_category) {
            throw new Error('Invalid AI response: missing predicted_category');
        }
        
        currentAIPrediction = data;
        showAIResult(data);
    } catch (error) {
        console.error('AI categorization error:', error);
        
        // Fallback to rule-based categorization
        const fallbackResult = getFallbackCategory(description);
        const fallbackData = {
            predicted_category: fallbackResult.category,
            confidence: fallbackResult.confidence,
            method: 'fallback_rules'
        };
        
        currentAIPrediction = fallbackData;
        showAIResult(fallbackData);
    }
}

// Simple fallback categorization with confidence
function getFallbackCategory(description) {
    const desc = description.toLowerCase();
    
    // High confidence matches
    if (desc.includes('waakye') || desc.includes('chop bar') || desc.includes('restaurant')) {
        return { category: 'food', confidence: 0.85 };
    }
    if (desc.includes('trotro') || desc.includes('taxi') || desc.includes('uber') || desc.includes('bolt')) {
        return { category: 'transport', confidence: 0.85 };
    }
    if (desc.includes('ecg') || desc.includes('electricity') || desc.includes('water company') || desc.includes('internet') || desc.includes('mtn') || desc.includes('vodafone')) {
        return { category: 'bills', confidence: 0.90 };
    }
    if (desc.includes('shoprite') || desc.includes('mall') || desc.includes('market')) {
        return { category: 'shopping', confidence: 0.85 };
    }
    
    // Medium confidence matches
    if (desc.includes('food') || desc.includes('eat') || desc.includes('lunch') || desc.includes('dinner')) {
        return { category: 'food', confidence: 0.70 };
    }
    if (desc.includes('transport') || desc.includes('fuel') || desc.includes('petrol')) {
        return { category: 'transport', confidence: 0.70 };
    }
    if (desc.includes('bill') || desc.includes('payment') || desc.includes('subscription')) {
        return { category: 'bills', confidence: 0.75 };
    }
    if (desc.includes('shop') || desc.includes('buy') || desc.includes('purchase')) {
        return { category: 'shopping', confidence: 0.65 };
    }
    
    // Low confidence default
    return { category: 'other', confidence: 0.40 };
}

function showAIResult(data) {
    document.getElementById('aiCategory').textContent = data.predicted_category || 'unknown';
    
    // Handle confidence value safely
    const confidence = data.confidence || 0;
    const confidencePercent = Math.round(confidence * 100);
    
    document.getElementById('aiConfidence').textContent = confidencePercent;
    document.getElementById('aiConfidenceBar').style.width = confidencePercent + '%';
    
    // Show model details
    const methodMap = {
        'enhanced_model_fallback': 'DialoGPT-small + Enhanced Keywords',
        'language_model': 'DialoGPT-small Language Model',
        'enhanced_keyword': 'Enhanced Keyword Matching',
        'fallback_rules': 'Rule-based Fallback',
        'default_enhanced': 'Default Enhanced Rules',
        'smol_vlm_model': 'SmolVLM Transformer',
        'keyword_fallback': 'Keyword Fallback'
    };
    
    const modelDetails = methodMap[data.method] || data.method || 'Unknown';
    document.getElementById('modelDetails').textContent = modelDetails;
    
    document.getElementById('aiResult').classList.remove('hidden');
    
    // Automatically set the category
    if (data.predicted_category) {
        document.getElementById('category').value = data.predicted_category;
    }
}

// Example buttons
document.querySelectorAll('.example-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('description').value = this.dataset.text;
        categorizeExpense(this.dataset.text);
    });
});

// Form submission
document.getElementById('expenseForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const selectedCategory = document.getElementById('category').value;
    const wasAIPredicted = currentAIPrediction && currentAIPrediction.predicted_category === selectedCategory;
    
    const formData = {
        amount: parseFloat(document.getElementById('amount').value),
        description: document.getElementById('description').value,
        category: selectedCategory,
        date: document.getElementById('date').value,
        ai_predicted: wasAIPredicted,
        ai_confidence: currentAIPrediction ? currentAIPrediction.confidence : null
    };
    
    try {
        // Save to database via API
        const response = await fetch('/api/expenses/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const savedExpense = await response.json();
            
            // Add to local array for immediate UI update
            expenses.push({
                ...savedExpense,
                aiPredicted: wasAIPredicted,
                manualOverride: currentAIPrediction && !wasAIPredicted
            });
            
            if (wasAIPredicted) {
                aiPredictionCount++;
            }
            
            updateStats();
            renderExpenses();
            
            // Reset form
            this.reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('aiResult').classList.add('hidden');
            document.getElementById('category').innerHTML = '<option value="">Waiting for AI categorization...</option><option value="food">Food</option><option value="transport">Transport</option><option value="shopping">Shopping</option><option value="bills">Bills</option><option value="entertainment">Entertainment</option><option value="healthcare">Healthcare</option><option value="education">Education</option><option value="travel">Travel</option><option value="other">Other</option>';
            currentAIPrediction = null;
        } else {
            const error = await response.json();
            alert('Error saving expense: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving expense:', error);
        alert('Error saving expense. Please try again.');
    }
});

// Token refresh function
async function refreshToken() {
    const refreshToken = localStorage.getItem('refresh_token');
    if (!refreshToken) return false;
    
    try {
        const response = await fetch('/api/auth/token/refresh/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refresh: refreshToken })
        });
        
        if (response.ok) {
            const data = await response.json();
            localStorage.setItem('access_token', data.access);
            return true;
        }
    } catch (error) {
        console.error('Token refresh failed:', error);
    }
    
    // Clear invalid tokens
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    return false;
}

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
    await init();
    
    // Listen for currency changes
    window.addEventListener('currencyChanged', function() {
        updateStats();
        renderExpenses();
    });
});
</script>
{% endblock %}